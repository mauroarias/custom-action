name: QA platform CI
on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
      dockerfile_path:
        required: true
        type: string
      itest_path: 
        required: true
        type: string
      migration_path: 
        type: string
      buid_arg: 
        type: string
jobs:
  build-docker:
    runs-on: ubuntu-latest    
    steps:
      - name: getting source code
        uses: actions/checkout@v3
        with:
          path: app
      - name: getting itest framework libs
        run: docker run --rm --platform linux/arm64 -v $(pwd):/scripts mauroarias/share-qa-lib:latest /bin/cp -rf /share-qa-libs/ /scripts/
        working-directory: app/${{ inputs.itest_path }}
      - name: building service
        run: docker build ${{ inputs.buid_arg }} -t $(echo ${{ inputs.service_name }} | awk '{print tolower($0)}'):test .
        working-directory: app/${{ inputs.dockerfile_path }}
      - name: run Itest
        run: ${{ inputs.itest_path }}/share-qa-libs/scripts/Itest.sh "${{ inputs.itest_path }}" "${{ inputs.migration_path }}"
        working-directory: app
      - name: Publishing Test Report & logs
        uses: actions/upload-artifact@v2
        with:
          name: reporting
          path: app/${{ inputs.itest_path }}/reporting